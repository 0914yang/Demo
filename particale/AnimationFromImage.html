<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>getImageData</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			min-width: 100vw; 
			min-height: 100vh;
		}
		#canvas {
			display: block;
			margin: 0 auto;
			padding: 0;
		}
	</style>
</head>
<body>
	<canvas id="canvas"></canvas>
	<img id="theImage" data-radius="1" style="display: none;" src="./narot.jpg" alt="leon">
	<script>
		window.onload = () => {

			const canvas = document.getElementById('canvas');
			canvas.width  = document.body.clientWidth;
			canvas.height = document.body.clientHeight;
			const ctx = canvas.getContext('2d');
			const theImage = document.getElementById('theImage');
			const initz = 300;
			const dots = [];
			let imageData, data, radius, ImgScale;

			//限制小球半径
			if (canvas.width > 500 || canvas.height > 300)
				theImage.dataset.radius >= 4 ? radius = theImage.dataset.radius : radius = 4;
			else 
				theImage.dataset.radius >= 2 ? radius = theImage.dataset.radius : radius = 2;




			//限制图片大小
			if(theImage.width > theImage.height) {
				ImgScale = theImage.height / theImage.width;
				theImage.width = canvas.width * .5;
				theImage.height = theImage.width * ImgScale;
			} else {
				ImgScale = theImage.width / theImage.height;
				theImage.height = canvas.height * .7;
				theImage.width = theImage.height * ImgScale;
			}

			//绘制图片到canvas
			ctx.drawImage(theImage, canvas.width / 2 - theImage.width / 2, canvas.height / 2 - theImage.height / 2, theImage.width, theImage.height);	
			imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
			data = imageData.data;

			//粒子化
			for(let x = 0; x < imageData.width; x += radius * 2) {
				for(let y = 0; y < imageData.height; y += radius * 2) {
					let i = (x + y * canvas.width) * 4;
					if(data[i+3] !== 0 && data[i] !== 255 && data[i+1] !== 255 && data[i+2] !== 255) {
						let dot = { r: 0, g: 0, b: 0, a: 0, x: 0, y: 0 };
						dot.r = data[i];
						dot.g = data[i+1];
						dot.b = data[i+2];
						dot.a = 1;
		                dot.ix = Math.random() * canvas.width; 		//初始化x轴坐标
		                dot.iy = Math.random() * canvas.height; 	//初始化y轴坐标
		                dot.iz = Math.random() * initz * 2 - initz; //初始化z轴坐标
		                dot.ir = 255;
		                dot.ig = 255;
		                dot.ib = 255;
		                dot.ia = 0;
						dot.x = x;
						dot.y = y;
						dot.z = 0;
						dots.push(dot);
					}
				}
			}

			//清除图像
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			//动画函数
			let finsh = false;
			let start = false;
			function animate() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				dots.map(dot => {
					if (Math.abs(dot.ix - dot.x) < 0.1 && Math.abs(dot.iy - dot.y) < 0.1 && Math.abs(dot.iz - dot.z) < 0.1) {
                            dot.ix = dot.x;
                            dot.iy = dot.y;
                            dot.iz = dot.z;
                            dot.ir = dot.r;
                            dot.ig = dot.g;
                            dot.ib = dot.b;
                            dot.ia = dot.a;
                            finsh = true;
                            // console.log("执行完毕！");
                        } else {
                            dot.ix += (dot.x - dot.ix) * 0.1;
                            dot.iy += (dot.y - dot.iy) * 0.1;
                            dot.iz += (dot.z - dot.iz) * 0.1;
                            dot.ir += (dot.r - dot.ir) * 0.1;
                            dot.ig += (dot.g - dot.ig) * 0.1;
                            dot.ib += (dot.b - dot.ib) * 0.1;
                            dot.ia += (dot.a - dot.ia) * 0.1;
                            finsh = false;
                        }

					drowDot(dot);
				});

				//判断动画是否完成
				if(!finsh && start) {
					requestAnimationFrame(animate);
				}
			}
			requestAnimationFrame(animate);


			function drowDot(dot) {
				let scale = initz / (initz + dot.iz);
                ctx.save();
				ctx.beginPath();
				ctx.fillStyle = `rgba(${Math.floor(dot.ir)}, ${Math.floor(dot.ig)}, ${Math.floor(dot.ib)}, ${dot.ia})`;
				ctx.arc(canvas.width / 2 + (dot.ix - canvas.width / 2) * scale, canvas.height / 2 + (dot.iy - canvas.height / 2) * scale, radius * scale, 0, Math.PI * 2);
				ctx.fill();
				ctx.closePath();
				ctx.restore();
			}


			//添加事件
			onkeyup = e => {
				if(e.keyCode === 13) {
					start = true;
					requestAnimationFrame(animate);
				}
			}
			onmouseup = e => {
				start = true;
				requestAnimationFrame(animate);
			}

		}
	</script>
</body>
</html>